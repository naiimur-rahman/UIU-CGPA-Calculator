<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIU CGPA & Probation Calculator (Renovated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --body-bg: #f4f7fa;
            --body-bg-image: none;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-tertiary: #718096;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-border: #e2e8f0;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --form-bg: #fdfdff;
            --form-border: #e2e8f0;
            --input-bg: #ffffff;
            --input-border: #cbd5e0;
            --input-text: #1a202c;
            --course-item-bg: #ffffff;
            --placeholder-bg: #f7fafc;
            --footer-text: #718096;
            --theme-toggle-bg: #e2e8f0;
            --theme-toggle-icon: #f6ad55;
        }

        body[data-theme="dark"] {
            --body-bg: #121212;
            --body-bg-image: url('https://www.uiu.ac.bd/wp-content/uploads/2022/11/UIU-Permanent-Campus-2.jpg');
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-tertiary: #718096;
            --card-bg: rgba(18, 18, 18, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6);
            --form-bg: rgba(26, 26, 26, 0.7);
            --form-border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(30, 30, 30, 0.7);
            --input-border: #4a5568;
            --input-text: #e2e8f0;
            --course-item-bg: rgba(45, 55, 72, 0.6);
            --placeholder-bg: rgba(26, 32, 44, 0.8);
            --footer-text: #a0aec0;
            --theme-toggle-bg: #2d3748;
            --theme-toggle-icon: #4299e1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            background-image: var(--body-bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 1.5rem; 
            box-shadow: var(--card-shadow);
            position: relative;
            transition: background-color 0.3s, border-color 0.3s;
        }
        @media (min-width: 640px) {
            .card {
                padding: 40px;
            }
        }
        .form-section {
             background-color: var(--form-bg);
             border: 1px solid var(--form-border);
             border-radius: 16px;
             padding: 24px;
             margin-bottom: 24px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        .form-input, .form-select {
            border-radius: 12px;
            border: 1px solid var(--input-border);
            padding: 10px 14px;
            transition: all 0.2s ease;
            background-color: var(--input-bg);
            color: var(--input-text);
            -webkit-appearance: none;
            appearance: none;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 12px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .btn-primary {
            background-color: #4f46e5; color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #10b981; color: white;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #e53e3e; color: white;
        }
        .btn-danger:hover {
            background-color: #c53030;
        }
        .btn-main-calc {
            background-image: linear-gradient(to right, #4f46e5, #6366f1);
            color: white; padding: 16px; font-size: 1.125rem;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .result-card { display: none; }
        
        .text-primary-color { color: var(--text-primary); }
        .text-secondary-color { color: var(--text-secondary); }
        .text-tertiary-color { color: var(--text-tertiary); }
        .course-list-placeholder-bg { background-color: var(--placeholder-bg); }
        .course-item-bg { background-color: var(--course-item-bg); }
        
        /* Result Card Themes */
        .result-good { background: linear-gradient(to bottom right, #f0fdfa, #ccfbf1); border-color: #5eead4; }
        .result-mid { background: linear-gradient(to bottom right, #fffbeb, #fef3c7); border-color: #fcd34d; }
        .result-low { background: linear-gradient(to bottom right, #fef2f2, #fee2e2); border-color: #fca5a5; }
        .planner-good { background-color: rgba(204, 251, 241, 0.5); border-color: #a7f3d0; }
        .planner-mid { background-color: rgba(254, 243, 199, 0.5); border-color: #fde68a; }
        .planner-low { background-color: rgba(254, 226, 226, 0.5); border-color: #fecaca; }

        body[data-theme="dark"] .result-good { background: linear-gradient(to bottom right, rgba(20, 70, 40, 0.8), rgba(30, 100, 60, 0.8)); border-color: rgba(40, 150, 80, 0.4); }
        body[data-theme="dark"] .result-mid { background: linear-gradient(to bottom right, rgba(70, 50, 20, 0.8), rgba(100, 70, 30, 0.8)); border-color: rgba(150, 110, 40, 0.4); }
        body[data-theme="dark"] .result-low { background: linear-gradient(to bottom right, rgba(70, 20, 20, 0.8), rgba(100, 30, 30, 0.8)); border-color: rgba(150, 40, 40, 0.4); }
        body[data-theme="dark"] .planner-good { background-color: rgba(20, 70, 40, 0.5); border-color: rgba(40, 150, 80, 0.3); }
        body[data-theme="dark"] .planner-mid { background-color: rgba(70, 50, 20, 0.5); border-color: rgba(150, 110, 40, 0.3); }
        body[data-theme="dark"] .planner-low { background-color: rgba(70, 20, 20, 0.5); border-color: rgba(150, 40, 40, 0.3); }

        /* Notification Snackbar Styles */
        #notification-container {
            position: fixed; top: 1.25rem; right: 1.25rem; z-index: 50;
        }
        .notification {
            background-color: #22c55e; color: white; padding: 1rem 1.5rem;
            border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex; align-items: center; gap: 0.5rem; 
            transform: translateX(120%); transition: transform 0.4s ease-in-out; margin-bottom: 0.5rem;
        }
        body[data-theme="dark"] .notification { background-color: #16a34a; }
        .notification.show { transform: translateX(0); }

        /* Theme Toggle */
        .theme-toggle {
            width: 50px; height: 26px; border-radius: 13px;
            background: var(--theme-toggle-bg);
            cursor: pointer; position: relative;
            transition: background-color 0.3s ease;
        }
        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 3px; left: 3px;
            width: 20px; height: 20px;
            border-radius: 50%;
            background-color: white;
            transition: transform 0.3s ease;
            color: var(--theme-toggle-icon);
            display: grid;
            place-items: center;
        }
        #theme-toggle-checkbox:checked + .theme-toggle::before {
            transform: translateX(24px);
        }
        
        /* For confetti */
        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 16px;
            background: #ffd300;
            top: 0;
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="notification-container"></div>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-3xl mx-auto card">
            
            <div class="absolute top-4 right-4 flex items-center space-x-3">
                <span id="theme-icon"></span>
                <input type="checkbox" id="theme-toggle-checkbox" class="sr-only">
                <label for="theme-toggle-checkbox" class="theme-toggle"></label>
            </div>
            
            <div class="text-center mb-10">
                <h1 class="text-3xl md:text-4xl font-extrabold text-primary-color">UIU CGPA Calculator</h1>
                <p class="text-secondary-color font-medium mt-2">Instantly calculate your CGPA and plan your academic future.</p>
            </div>

            <!-- Current Standing Section -->
            <div class="form-section">
                <h2 class="text-xl font-bold text-primary-color mb-4">Current Academic Standing <span class="text-sm font-normal text-secondary-color">(Optional)</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="current-cgpa" class="block text-sm font-medium text-tertiary-color mb-2">Current CGPA</label>
                        <input type="number" id="current-cgpa" step="0.01" min="0.00" max="4.00" class="w-full form-input" placeholder="e.g., 3.50">
                        <p id="cgpa-error" class="text-red-500 text-sm mt-2 hidden"></p>
                    </div>
                    <div>
                        <label for="completed-credits" class="block text-sm font-medium text-tertiary-color mb-2">Completed Credits</label>
                        <input type="number" id="completed-credits" step="0.5" min="0" class="w-full form-input" placeholder="e.g., 90">
                    </div>
                </div>
            </div>

            <!-- Add New Courses Section -->
            <div class="form-section">
                <h2 class="text-xl font-bold text-primary-color mb-4">This Trimester's Courses</h2>
                <form id="add-course-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="course-credit" class="block text-sm font-medium text-tertiary-color mb-2">Credit Hours</label>
                        <select id="course-credit" class="w-full form-select">
                            <option value="3">3 Credits</option>
                            <option value="2">2 Credits</option>
                            <option value="1">1 Credit</option>
                        </select>
                    </div>
                    <div>
                        <label for="course-grade" class="block text-sm font-medium text-tertiary-color mb-2">Expected Grade</label>
                        <select id="course-grade" class="w-full form-select">
                            <option value="4.00">A (4.00)</option>
                            <option value="3.67">A- (3.67)</option>
                            <option value="3.33">B+ (3.33)</option>
                            <option value="3.00">B (3.00)</option>
                            <option value="2.67">B- (2.67)</option>
                            <option value="2.33">C+ (2.33)</option>
                            <option value="2.00">C (2.00)</option>
                            <option value="1.67">C- (1.67)</option>
                            <option value="1.33">D+ (1.33)</option>
                            <option value="1.00">D (1.00)</option>
                            <option value="0.00">F (0.00)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full btn btn-primary"><i data-lucide="plus-circle" class="w-5 h-5"></i>Add Course</button>
                </form>
            </div>

            <!-- Add Retake Courses Section -->
            <div class="form-section">
                <h2 class="text-xl font-bold text-primary-color mb-4">Retake Courses <span class="text-sm font-normal text-secondary-color">(Optional)</span></h2>
                <form id="add-retake-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="retake-credit" class="block text-sm font-medium text-tertiary-color mb-2">Credits</label>
                        <select id="retake-credit" class="w-full form-select">
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                        </select>
                    </div>
                    <div>
                        <label for="retake-old-grade" class="block text-sm font-medium text-tertiary-color mb-2">Old Grade</label>
                        <select id="retake-old-grade" class="w-full form-select">
                            <option value="3.67">A- (3.67)</option>
                            <option value="3.33">B+ (3.33)</option>
                            <option value="3.00">B (3.00)</option>
                            <option value="2.67">B- (2.67)</option>
                            <option value="2.33">C+ (2.33)</option>
                            <option value="2.00">C (2.00)</option>
                            <option value="1.67">C- (1.67)</option>
                            <option value="1.33">D+ (1.33)</option>
                            <option value="1.00">D (1.00)</option>
                            <option value="0.00" selected>F (0.00)</option>
                        </select>
                    </div>
                    <div>
                        <label for="retake-new-grade" class="block text-sm font-medium text-tertiary-color mb-2">New Grade</label>
                        <select id="retake-new-grade" class="w-full form-select">
                            <option value="4.00">A (4.00)</option>
                            <option value="3.67">A- (3.67)</option>
                            <option value="3.33">B+ (3.33)</option>
                            <option value="3.00">B (3.00)</option>
                            <option value="2.67">B- (2.67)</option>
                            <option value="2.33">C+ (2.33)</option>
                            <option value="2.00">C (2.00)</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full btn btn-secondary"><i data-lucide="repeat" class="w-5 h-5"></i>Add Retake</button>
                </form>
            </div>

            <!-- Course List -->
            <div id="course-list-container" class="space-y-3 my-8"></div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="reset-all" class="w-full btn btn-danger"><i data-lucide="refresh-cw" class="w-6 h-6"></i>Reset All</button>
                <button id="calculate-cgpa" class="w-full btn btn-main-calc"><i data-lucide="calculator" class="w-6 h-6"></i>Calculate CGPA</button>
            </div>
            <p id="calc-error" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            
            <!-- Result Section -->
            <div id="result-section" class="mt-8">
                <!-- Good Standing -->
                <div id="result-good" class="result-card w-full">
                    <div class="result-good border rounded-xl p-6 text-center">
                        <h3 id="good-standing-title" class="text-2xl font-bold text-green-800 mb-4">Excellent!</h3>
                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:divide-x-2 divide-green-200/50">
                            <div class="flex-1 px-4">
                                <p class="text-green-600 text-lg">New CGPA</p>
                                <p id="cgpa-good" class="text-4xl sm:text-5xl md:text-6xl font-bold text-green-700 my-2">0.00</p>
                                <p class="text-sm text-secondary-color">Total Credits: <span id="total-credits-good">0</span></p>
                            </div>
                            <div class="flex-1 px-4 pt-4 md:pt-0 border-t-2 md:border-t-0 border-green-200/50">
                                <p class="text-green-600 text-lg">Trimester GPA</p>
                                <p id="tgpa-good" class="text-4xl sm:text-5xl md:text-6xl font-bold text-green-700 my-2">0.00</p>
                                <p class="text-sm text-secondary-color">This Trimester</p>
                            </div>
                        </div>
                    </div>
                     <div class="mt-6 w-full planner-good p-4 rounded-lg border">
                        <h4 class="text-lg font-semibold text-primary-color text-center">Target CGPA Planner</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="target-cgpa-good" class="block text-sm font-medium text-tertiary-color mb-1">Target CGPA</label>
                                <input type="number" id="target-cgpa-good" step="0.01" min="0.00" max="4.00" class="w-full form-input" placeholder="e.g., 3.75">
                            </div>
                            <div>
                                <label for="target-credits-good" class="block text-sm font-medium text-tertiary-color mb-1">Next Trimester Credits</label>
                                <input type="number" id="target-credits-good" min="6" step="0.5" class="w-full form-input" placeholder="e.g., 9">
                            </div>
                        </div>
                        <div id="target-result-good" class="mt-4 text-center hidden">
                            <p class="text-tertiary-color">You'll need a GPA of:</p>
                            <p id="required-gpa-good" class="text-3xl font-bold text-green-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Mid Standing -->
                <div id="result-mid" class="result-card w-full">
                    <div class="result-mid border rounded-xl p-6 text-center">
                        <h3 id="mid-standing-title" class="text-2xl font-bold text-orange-800 mb-4">Keep Pushing!</h3>
                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:divide-x-2 divide-orange-200/50">
                            <div class="flex-1 px-4">
                                <p class="text-orange-600 text-lg">New CGPA</p>
                                <p id="cgpa-mid" class="text-4xl sm:text-5xl md:text-6xl font-bold text-orange-700 my-2">0.00</p>
                                <p class="text-sm text-secondary-color">Total Credits: <span id="total-credits-mid">0</span></p>
                            </div>
                            <div class="flex-1 px-4 pt-4 md:pt-0 border-t-2 md:border-t-0 border-orange-200/50">
                                <p class="text-orange-600 text-lg">Trimester GPA</p>
                                <p id="tgpa-mid" class="text-4xl sm:text-5xl md:text-6xl font-bold text-orange-700 my-2">0.00</p>
                                <p class="text-sm text-secondary-color">This Trimester</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 w-full planner-mid p-4 rounded-lg border">
                        <h4 class="text-lg font-semibold text-primary-color text-center">Target CGPA Planner</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="target-cgpa-mid" class="block text-sm font-medium text-tertiary-color mb-1">Target CGPA</label>
                                <input type="number" id="target-cgpa-mid" step="0.01" min="0.00" max="4.00" class="w-full form-input" placeholder="e.g., 3.00">
                            </div>
                            <div>
                                <label for="target-credits-mid" class="block text-sm font-medium text-tertiary-color mb-1">Next Trimester Credits</label>
                                <input type="number" id="target-credits-mid" min="6" step="0.5" class="w-full form-input" placeholder="e.g., 12">
                            </div>
                        </div>
                        <div id="target-result-mid" class="mt-4 text-center hidden">
                            <p class="text-tertiary-color">You'll need a GPA of:</p>
                            <p id="required-gpa-mid" class="text-3xl font-bold text-orange-600"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Low CGPA Result -->
                <div id="result-low" class="result-card w-full">
                     <div class="result-low border rounded-xl p-6 text-center">
                         <h3 id="low-cgpa-title" class="text-2xl font-bold text-red-800 mb-4">Probation!</h3>
                         <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:divide-x-2 divide-red-200/50">
                             <div class="flex-1 px-4">
                                 <p class="text-red-600 text-lg">New CGPA</p>
                                 <p id="cgpa-low" class="text-4xl sm:text-5xl md:text-6xl font-bold text-red-700 my-2">0.00</p>
                                 <p class="text-sm text-secondary-color">Total Credits: <span id="total-credits-low">0</span></p>
                             </div>
                             <div class="flex-1 px-4 pt-4 md:pt-0 border-t-2 md:border-t-0 border-red-200/50">
                                 <p class="text-red-600 text-lg">Trimester GPA</p>
                                 <p id="tgpa-low" class="text-4xl sm:text-5xl md:text-6xl font-bold text-red-700 my-2">0.00</p>
                                 <p class="text-sm text-secondary-color">This Trimester</p>
                             </div>
                         </div>
                     </div>
                     <div class="mt-6 w-full planner-low p-4 rounded-lg border">
                         <h4 class="text-lg font-semibold text-primary-color text-center">Recovery Plan</h4>
                         <p class="text-center text-secondary-color mb-4">Let's find out what you need in your next trimester to reach a 2.0 CGPA.</p>
                         <div class="max-w-xs mx-auto">
                             <label for="next-credits" class="block text-sm font-medium text-tertiary-color mb-1">Next trimester's credits:</label>
                             <input type="number" id="next-credits" min="6" step="0.5" class="w-full form-input" placeholder="e.g., 9">
                         </div>

                         <div id="recovery-result" class="mt-4 text-center hidden">
                             <p class="text-tertiary-color">To get out of probation, you need a GPA of:</p>
                             <p id="required-gpa" class="text-3xl font-bold text-red-600"></p>
                         </div>
                     </div>
                 </div>
            </div>
        </div>
        <footer class="text-center mt-8 text-sm text-secondary-color font-semibold">
            <p>Developed by <a href="https://www.facebook.com/naiimurr" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">Naimur Rahman</a> (CSE 242) for the students of UIU❤️</p>
        </footer>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements --- //
            const getEl = (id) => document.getElementById(id);
            const body = document.body;
            const themeToggle = getEl('theme-toggle-checkbox');
            const themeIcon = getEl('theme-icon');
            
            // Forms & Inputs
            const currentCgpaInput = getEl('current-cgpa');
            const completedCreditsInput = getEl('completed-credits');
            const addCourseForm = getEl('add-course-form');
            const courseCreditEl = getEl('course-credit');
            const courseGradeEl = getEl('course-grade');
            const addRetakeForm = getEl('add-retake-form');
            const retakeCreditEl = getEl('retake-credit');
            const retakeOldGradeEl = getEl('retake-old-grade');
            const retakeNewGradeEl = getEl('retake-new-grade');
            
            // Containers & Buttons
            const courseListContainer = getEl('course-list-container');
            const calculateBtn = getEl('calculate-cgpa');
            const resetBtn = getEl('reset-all');
            
            // Error Messages
            const cgpaErrorEl = getEl('cgpa-error');
            const calcErrorEl = getEl('calc-error');
            
            // Result Cards
            const resultCards = {
                good: getEl('result-good'),
                mid: getEl('result-mid'),
                low: getEl('result-low'),
            };
            const allResultCards = document.querySelectorAll('.result-card');

            // --- State --- //
            let courses = [];
            let calculationCache = {
                finalCgpa: 0,
                totalGpaCredits: 0,
                currentTotalPoints: 0,
            };

            // --- Theme Management --- //
            const updateTheme = (isDark) => {
                body.setAttribute('data-theme', isDark ? 'dark' : 'light');
                themeToggle.checked = isDark;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                themeIcon.innerHTML = isDark ? 
                    '<i data-lucide="moon" class="w-5 h-5 text-blue-300"></i>' : 
                    '<i data-lucide="sun" class="w-5 h-5 text-yellow-500"></i>';
                lucide.createIcons();
            };

            themeToggle.addEventListener('change', () => updateTheme(themeToggle.checked));
            
            const initializeTheme = () => {
                const savedTheme = localStorage.getItem('theme');
                // Default to light theme unless 'dark' is explicitly saved.
                updateTheme(savedTheme === 'dark');
            };

            // --- Local Storage Persistence --- //
            const saveState = () => {
                const state = {
                    courses,
                    currentCgpa: currentCgpaInput.value,
                    completedCredits: completedCreditsInput.value
                };
                localStorage.setItem('cgpaCalculatorState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('cgpaCalculatorState');
                if (savedState) {
                    const { courses: savedCourses, currentCgpa, completedCredits } = JSON.parse(savedState);
                    courses = savedCourses || [];
                    currentCgpaInput.value = currentCgpa || '';
                    completedCreditsInput.value = completedCredits || '';
                    renderCourses();
                }
            };

            // --- UI & Animations --- //
            const showNotification = (message, type = 'success') => {
                const container = getEl('notification-container');
                const notification = document.createElement('div');
                notification.className = 'notification';
                const icon = type === 'error' ? 'alert-circle' : 'check-circle';
                notification.style.backgroundColor = type === 'error' ? '#ef4444' : '#22c55e';
                notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
                
                container.appendChild(notification);
                lucide.createIcons();

                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 3000);
            };

            const animateCountUp = (el, endValue) => {
                let startValue = 0;
                const duration = 1000;
                const startTime = performance.now();

                function step(currentTime) {
                    const elapsedTime = currentTime - startTime;
                    const progress = Math.min(elapsedTime / duration, 1);
                    const currentValue = startValue + (endValue - startValue) * progress;
                    el.textContent = currentValue.toFixed(2);
                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        el.textContent = endValue.toFixed(2);
                    }
                }
                requestAnimationFrame(step);
            };
            
             const triggerConfetti = () => {
                const parent = document.querySelector('.card');
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#6366f1'];
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animation = `fall ${1.5 + Math.random() * 2}s ${Math.random() * 1}s linear forwards`;
                    parent.appendChild(confetti);
                }
                const keyframes = `
                @keyframes fall {
                    to {
                        transform: translateY(100vh) rotate(${Math.random() * 720}deg);
                        opacity: 0;
                    }
                }`;
                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.innerText = keyframes;
                document.head.appendChild(styleSheet);
                setTimeout(() => document.querySelectorAll('.confetti-piece').forEach(e => e.remove()), 4000);
            };

            // --- Core Logic --- //
            const getGradeLetter = (grade) => {
                const gradeMap = {4.00:'A',3.67:'A-',3.33:'B+',3.00:'B',2.67:'B-',2.33:'C+',2.00:'C',1.67:'C-',1.33:'D+',1.00:'D',0.00:'F'};
                return gradeMap[grade] || '';
            };

            const renderCourses = () => {
                courseListContainer.innerHTML = '';
                if (courses.length === 0) {
                    courseListContainer.innerHTML = `<div class="text-center text-secondary-color p-4 course-list-placeholder-bg rounded-lg fade-in"><p>No courses added yet.</p></div>`;
                    return;
                }

                courses.forEach((course, index) => {
                    const courseEl = document.createElement('div');
                    courseEl.style.setProperty('--stagger-delay', `${index * 100}ms`);
                    let courseHTML = '';
                    let borderColor = course.type === 'new' ? 'border-l-4 border-blue-500' : 'border-l-4 border-indigo-500';

                    if (course.type === 'new') {
                        courseHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-tertiary-color">${course.credit} Credits</p>
                            </div>
                            <div class="text-center">
                                <span class="font-bold text-lg text-blue-400">${getGradeLetter(course.grade)}</span>
                                <span class="block text-xs text-secondary-color">(${course.grade.toFixed(2)})</span>
                            </div>`;
                    } else {
                        courseHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-tertiary-color">${course.credit} Credits <span class="font-bold text-indigo-400">(Retake)</span></p>
                            </div>
                            <div class="text-center">
                                <span class="font-bold text-secondary-color line-through">${getGradeLetter(course.oldGrade)}</span>
                                <i data-lucide="arrow-right" class="inline-block w-4 h-4 text-secondary-color mx-1"></i>
                                <span class="font-bold text-lg text-green-400">${getGradeLetter(course.newGrade)}</span>
                            </div>`;
                    }
                    
                    courseEl.className = `flex justify-between items-center p-4 rounded-lg shadow-sm border ${borderColor} course-item-bg fade-in-up`;
                    courseEl.innerHTML = courseHTML + `
                        <button class="remove-btn text-red-500 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/50 p-2 rounded-full transition-colors" data-index="${index}">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>`;
                    courseListContainer.appendChild(courseEl);
                });
                lucide.createIcons();
            };
            
            const hideResults = () => {
                allResultCards.forEach(card => card.style.display = 'none');
                allResultCards.forEach(card => card.classList.remove('fade-in-up'));
                [cgpaErrorEl, calcErrorEl].forEach(el => el.classList.add('hidden'));
            };

            const calculateResults = () => {
                const currentCgpa = parseFloat(currentCgpaInput.value) || 0;
                const completedCredits = parseFloat(completedCreditsInput.value) || 0;
                const hasInitialStanding = completedCredits > 0 && currentCgpaInput.value.trim() !== '';

                const initialPoints = currentCgpa * completedCredits;
                let totalPoints = initialPoints;
                let totalGpaCredits = completedCredits;
                let totalEarnedCredits = completedCredits;

                let trimesterPoints = 0;
                let trimesterGpaCredits = 0;

                courses.forEach(course => {
                    trimesterGpaCredits += course.credit;
                    const grade = course.type === 'new' ? course.grade : course.newGrade;
                    trimesterPoints += course.credit * grade;

                    // If it's a new course OR if no initial standing is provided, treat as a new addition.
                    if (course.type === 'new' || !hasInitialStanding) {
                        totalPoints += course.credit * grade;
                        totalGpaCredits += course.credit;
                        if (grade > 0) totalEarnedCredits += course.credit;
                    } else { // Retake with initial standing provided
                        totalPoints += (grade - course.oldGrade) * course.credit;
                        // If retaking an 'F', the student now earns these credits.
                        // The GPA credits (denominator) do not change as they were already included for the F grade.
                        if (course.oldGrade === 0.00 && grade > 0.00) {
                            totalEarnedCredits += course.credit;
                        }
                    }
                });

                const finalCgpa = totalGpaCredits > 0 ? totalPoints / totalGpaCredits : 0;
                const trimesterGpa = trimesterGpaCredits > 0 ? trimesterPoints / trimesterGpaCredits : 0;
                
                calculationCache = { finalCgpa, totalGpaCredits, currentTotalPoints: totalPoints };

                return { finalCgpa, trimesterGpa, totalEarnedCredits };
            };
            
            const displayResults = ({ finalCgpa, trimesterGpa, totalEarnedCredits }) => {
                let card, cgpaEl, tgpaEl, creditsEl, titleEl, standing;
                
                if (finalCgpa >= 3.0) {
                    standing = 'good';
                    titleEl = getEl('good-standing-title');
                    if (finalCgpa >= 3.8) {
                        titleEl.textContent = "তুখোড় ইশটুডেন্ট! 🎓";
                        if(trimesterGpa >= 3.8) triggerConfetti();
                    } else if (finalCgpa >= 3.5) {
                        titleEl.textContent = "ওয়েভারওয়ালা! 💸";
                    } else if (finalCgpa >= 3.2) {
                        titleEl.textContent = "সেইফ জোনে আছেন 😌";
                    } else {
                        titleEl.textContent = "সিজি ৩.০০ ধরে রাখেন! 😅";
                    }
                } else if (finalCgpa >= 2.0) {
                    standing = 'mid';
                    titleEl = getEl('mid-standing-title');
                    if (finalCgpa >= 2.6) {
                        titleEl.textContent = "আরেকটু পরিশ্রম করুন! 💪";
                    } else if (finalCgpa >= 2.2) {
                        titleEl.textContent = "রেড জোনে আছেন! 🚨";
                    } else {
                        titleEl.textContent = "আরেকটু হলেই লেটার ধরিয়ে দেবে! 📉";
                    }
                } else {
                    standing = 'low';
                    titleEl = getEl('low-cgpa-title');
                    if(finalCgpa < 1.5) {
                        titleEl.textContent = "RIP 💀";
                    } else {
                        titleEl.textContent = "জঘন্য রকমের পরিশ্রমী হন! 🤯";
                    }
                }

                card = resultCards[standing];
                cgpaEl = getEl(`cgpa-${standing}`);
                tgpaEl = getEl(`tgpa-${standing}`);
                creditsEl = getEl(`total-credits-${standing}`);
                
                animateCountUp(cgpaEl, finalCgpa);
                animateCountUp(tgpaEl, trimesterGpa);
                creditsEl.textContent = totalEarnedCredits.toFixed(2).replace(/\.00$/, '');

                card.style.display = 'block';
                setTimeout(() => card.classList.add('fade-in-up'), 10);
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            const handleTargetCalculation = (targetCgpaInput, targetCreditsInput, resultEl, gpaEl) => {
                const targetCgpa = parseFloat(targetCgpaInput.value);
                const nextCredits = parseFloat(targetCreditsInput.value);
                
                if (isNaN(targetCgpa) || isNaN(nextCredits) || nextCredits < 6 || targetCgpa <= calculationCache.finalCgpa || targetCgpa > 4.00) {
                    resultEl.classList.add('hidden');
                    return;
                }

                const targetTotalPoints = targetCgpa * (calculationCache.totalGpaCredits + nextCredits);
                const requiredNextPoints = targetTotalPoints - calculationCache.currentTotalPoints;
                const requiredGpa = requiredNextPoints / nextCredits;
                
                resultEl.classList.remove('hidden');
                if (requiredGpa > 4.0) gpaEl.textContent = `Impossible (${requiredGpa.toFixed(2)})`;
                else if (requiredGpa < 0) gpaEl.textContent = `Achieved!`;
                else gpaEl.textContent = requiredGpa.toFixed(2);
            };

            // --- Event Listeners --- //
            [currentCgpaInput, completedCreditsInput].forEach(el => el.addEventListener('input', saveState));

            addCourseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                courses.push({ type: 'new', credit: parseFloat(courseCreditEl.value), grade: parseFloat(courseGradeEl.value) });
                renderCourses(); hideResults(); saveState();
                showNotification('Course added!');
            });

            addRetakeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const credit = parseFloat(retakeCreditEl.value);
                const oldGrade = parseFloat(retakeOldGradeEl.value);
                const newGrade = parseFloat(retakeNewGradeEl.value);
                if (oldGrade >= newGrade) {
                    showNotification("New grade must be higher.", 'error');
                    return;
                }
                courses.push({ type: 'retake', credit, oldGrade, newGrade });
                renderCourses(); hideResults(); saveState();
                showNotification('Retake course added!');
            });
            
            courseListContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-btn');
                if (removeBtn) {
                    courses.splice(parseInt(removeBtn.dataset.index), 1);
                    renderCourses(); hideResults(); saveState();
                }
            });

            calculateBtn.addEventListener('click', () => {
                hideResults();
                if (courses.length === 0) {
                    calcErrorEl.textContent = "Please add at least one course.";
                    calcErrorEl.classList.remove('hidden');
                    return;
                }
                const results = calculateResults();
                displayResults(results);
            });
            
            resetBtn.addEventListener('click', () => {
                courses = [];
                currentCgpaInput.value = '';
                completedCreditsInput.value = '';
                renderCourses();
                hideResults();
                saveState();
                showNotification('Calculator has been reset.', 'success');
            });
            
            // Probation Planner
            getEl('next-credits').addEventListener('input', (e) => {
                const nextCredits = parseFloat(e.target.value);
                const resultEl = getEl('recovery-result');
                const gpaEl = getEl('required-gpa');
                if (isNaN(nextCredits) || nextCredits < 6) {
                    resultEl.classList.add('hidden'); return;
                }
                const targetTotalPoints = 2.0 * (calculationCache.totalGpaCredits + nextCredits);
                const requiredNextPoints = targetTotalPoints - calculationCache.currentTotalPoints;
                const requiredGpa = requiredNextPoints / nextCredits;
                resultEl.classList.remove('hidden');
                if (requiredGpa > 4.0) gpaEl.textContent = `Impossible (${requiredGpa.toFixed(2)})`;
                else if (requiredGpa <= 0) gpaEl.textContent = 'Any passing grade!';
                else gpaEl.textContent = requiredGpa.toFixed(2);
            });

            // Target Planners
            ['good', 'mid'].forEach(standing => {
                const targetCgpaInput = getEl(`target-cgpa-${standing}`);
                const targetCreditsInput = getEl(`target-credits-${standing}`);
                const resultEl = getEl(`target-result-${standing}`);
                const gpaEl = getEl(`required-gpa-${standing}`);
                [targetCgpaInput, targetCreditsInput].forEach(el => el.addEventListener('input', () => {
                    handleTargetCalculation(targetCgpaInput, targetCreditsInput, resultEl, gpaEl);
                }));
            });

            // --- Initialization --- //
            initializeTheme();
            loadState();
            lucide.createIcons();
        });
    </script>
</body>
</html>




